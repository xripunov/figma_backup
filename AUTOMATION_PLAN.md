# План по автоматизации резервного копирования Figma

Этот документ описывает план по настройке ежедневного автоматического запуска бэкапа в 20:00.

## Общая концепция

Мы реализуем автоматизацию через URL-схему. Приложение будет "слушать" специальную ссылку (`figma-bckp://start-backup`), а системный планировщик `launchd` будет "открывать" эту ссылку по расписанию, тем самым запуская процесс бэкапа.

Весь процесс настройки будет инициироваться пользователем из интерфейса приложения нажатием одной кнопки.

---

## Часть 1: Изменения в приложении

Чтобы приложение могло реагировать на внешние команды и управлять автоматизацией, необходимо внести следующие изменения:

1.  **Добавить зависимость:** В файл `pubspec.yaml` будет добавлен пакет `uni_links` для работы с URL-схемами.
2.  **Зарегистрировать URL-схему:** В конфигурационный файл `macos/Runner/Info.plist` будут добавлены строки, которые сообщат macOS, что ссылки вида `figma-bckp://` должно обрабатывать наше приложение.
3.  **Реализовать "слушателя" и сценарий автозапуска:** В код Dart будет добавлена логика, которая при запуске приложения проверяет, не было ли оно вызвано по специальной ссылке. Если ссылка — `figma-bckp://start-backup`, приложение выполнит следующий сценарий:
    *   Приложение запускается или, если уже было запущено, выходит на передний план.
    *   **Принудительно обновляет данные:** Запускается процесс обновления списка команд, проектов и файлов Figma, чтобы гарантировать актуальность данных. Пользователь видит индикатор загрузки на главном экране.
    *   **Переходит на экран бэкапа:** Сразу после успешного обновления данных приложение автоматически переключается на экран резервного копирования.
    *   **Запускает процесс:** На экране бэкапа автоматически стартует процесс скачивания файлов. Пользователь может наблюдать за прогрессом в реальном времени.
4.  **Добавить управление автоматизацией:** В экран настроек будут добавлены элементы интерфейса (например, кнопка "Включить/Отключить ежедневный бэкап"), которые позволят пользователю управлять процессом.

---

## Часть 2: Реализация автоматической настройки

Вместо ручной настройки со стороны пользователя, приложение будет делать всё само.

### Включение автоматизации

Когда пользователь нажимает кнопку "Включить ежедневный бэкап":

1.  **Генерация `.plist` файла:** Приложение создает в памяти `.plist` файл для `launchd`. Этот файл будет содержать команду для прямого вызова URL-схемы через системную утилиту `open`, что избавляет от необходимости создавать "Команду" (Shortcut) вручную.

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <key>Label</key>
        <string>com.figma_bckp.scheduler</string>
        <key>ProgramArguments</key>
        <array>
            <string>open</string>
            <string>figma-bckp://start-backup</string>
        </array>
        <key>StartCalendarInterval</key>
        <dict>
            <key>Hour</key>
            <integer>20</integer>
            <key>Minute</key>
            <integer>0</integer>
        </dict>
    </dict>
    </plist>
    ```
    *В будущем, здесь можно будет настраивать время и периодичность из интерфейса приложения.*

2.  **Сохранение файла:** Приложение сохраняет этот файл по пути `~/Library/LaunchAgents/com.figma_bckp.scheduler.plist`.
3.  **Активация задачи:** Приложение выполняет shell-команду `launchctl load ~/Library/LaunchAgents/com.figma_bckp.scheduler.plist` для немедленной активации задачи без необходимости перезагрузки.

### Отключение автоматизации

Когда пользователь нажимает кнопку "Отключить ежедневный бэкап":

1.  **Деактивация задачи:** Приложение выполняет shell-команду `launchctl unload ~/Library/LaunchAgents/com.figma_bckp.scheduler.plist`.
2.  **Удаление файла:** Приложение удаляет файл `com.figma_bckp.scheduler.plist` из папки `~/Library/LaunchAgents`, чтобы полностью отменить автоматизацию.